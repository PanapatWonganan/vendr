<?php

namespace App\Filament\Resources;

use App\Filament\Resources\PurchaseOrderResource\Pages;
use App\Filament\Resources\PurchaseOrderResource\RelationManagers;
use App\Models\PurchaseOrder;
use App\Models\PurchaseRequisition;
use App\Filament\Actions\ApprovePurchaseOrderAction;
use App\Filament\Actions\RejectPurchaseOrderAction;
use Filament\Forms;
use Filament\Forms\Form;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\SoftDeletingScope;
use Illuminate\Support\Facades\Auth;
use Filament\Notifications\Notification;
use Illuminate\Support\Facades\Storage;

class PurchaseOrderResource extends Resource
{
    protected static ?string $model = PurchaseOrder::class;

    protected static ?string $navigationIcon = 'heroicon-o-shopping-cart';
    protected static ?string $navigationLabel = 'Purchase Orders (ใบสั่งซื้อ)';
    protected static ?string $modelLabel = 'ใบสั่งซื้อ';
    protected static ?string $pluralModelLabel = 'ใบสั่งซื้อ';
    protected static ?string $navigationGroup = 'Procurement (จัดซื้อจัดจ้าง)';
    protected static ?int $navigationSort = 2;

    public static function form(Form $form): Form
    {
        return $form
            ->schema([
                // ข้อมูลหลักของ PO
                Forms\Components\Section::make('ข้อมูลหลักของ PO')
                    ->schema([
                        Forms\Components\Grid::make(2)->schema([
                            Forms\Components\TextInput::make('po_number')
                                ->label('เลขที่ PO')
                                ->disabled()
                                ->dehydrated(false)
                                ->default(fn () => 'Auto-generated')
                                ->visibleOn('create'),

                            Forms\Components\TextInput::make('sap_po_number')
                                ->label('PO จาก SAP')
                                ->maxLength(255)
                                ->placeholder('กรอกเลขที่ PO จากระบบ SAP (ถ้ามี)')
                                ->helperText('สำหรับเลข PO ที่มาจากภายนอก/SAP'),
                        ]),

                        Forms\Components\Grid::make(2)->schema([
                            Forms\Components\TextInput::make('po_title')
                                ->label('ชื่องาน')
                                ->required()
                                ->maxLength(255),

                            Forms\Components\Select::make('work_type')
                                ->label('ประเภทของงาน')
                                ->required()
                                ->options([
                                    'buy' => 'ซื้อ',
                                    'hire' => 'จ้าง',
                                    'rent' => 'เช่า',
                                ]),
                        ]),

                        Forms\Components\Select::make('procurement_method')
                            ->label('วิธีการจัดหา')
                            ->options([
                                'agreement_price' => 'ตกลงราคา',
                                'invitation_bid' => 'เชิญชวน',
                                'open_bid' => 'ประกวดราคาอิเล็กทรอนิกส์ (e-bidding)',
                                'special_1' => 'วิธีพิเศษ (กรณีที่ 1)',
                                'special_2' => 'วิธีพิเศษ (กรณีที่ 2)',
                                'selection' => 'คัดเลือก',
                            ])
                            ->columnSpanFull(),
                    ]),

                // ข้อมูลบริษัทและผู้ติดต่อ  
                Forms\Components\Section::make('ข้อมูลบริษัทและผู้ติดต่อ')
                    ->schema([
                        Forms\Components\Grid::make(3)->schema([
                            Forms\Components\Select::make('vendor_id')
                                ->label('เลือกผู้ขาย')
                                ->relationship('vendor', 'company_name')
                                ->required()
                                ->searchable()
                                ->preload()
                                ->live()
                                ->afterStateUpdated(function ($state, Forms\Set $set) {
                                    if ($state) {
                                        $vendor = \App\Models\Vendor::find($state);
                                        if ($vendor) {
                                            $set('contact_name', $vendor->contact_name);
                                            $set('contact_email', $vendor->contact_email);
                                        }
                                    }
                                }),

                            Forms\Components\TextInput::make('contact_name')
                                ->label('ชื่อผู้ติดต่อ')
                                ->required()
                                ->maxLength(255),

                            Forms\Components\TextInput::make('contact_email')
                                ->label('E-mail')
                                ->required()
                                ->email()
                                ->maxLength(255),
                        ]),

                        Forms\Components\Grid::make(3)->schema([
                            Forms\Components\DatePicker::make('order_date')
                                ->label('วันที่สั่งซื้อ')
                                ->required()
                                ->default(now()),

                            Forms\Components\DatePicker::make('expected_delivery_date')
                                ->label('วันที่คาดว่าจะได้รับสินค้า')
                                ->minDate(now()),

                            Forms\Components\Select::make('department_id')
                                ->label('แผนก')
                                ->relationship('department', 'name')
                                ->required()
                                ->searchable()
                                ->preload(),
                        ]),

                        Forms\Components\TextInput::make('delivery_address')
                            ->label('ที่อยู่จัดส่ง')
                            ->maxLength(500)
                            ->columnSpanFull(),
                    ]),

                // ข้อมูลทางการเงิน
                Forms\Components\Section::make('ข้อมูลทางการเงิน')
                    ->schema([
                        Forms\Components\Grid::make(2)->schema([
                            Forms\Components\Select::make('currency')
                                ->label('สกุลเงิน')
                                ->default('THB')
                                ->options([
                                    'THB' => 'บาท (THB)',
                                    'USD' => 'ดอลลาร์ (USD)',
                                    'EUR' => 'ยูโร (EUR)',
                                ]),

                            Forms\Components\TextInput::make('exchange_rate')
                                ->label('อัตราแลกเปลี่ยน')
                                ->numeric()
                                ->default(1.0000)
                                ->step(0.0001)
                                ->minValue(0.0001),
                        ]),

                        Forms\Components\Grid::make(3)->schema([
                            Forms\Components\TextInput::make('subtotal')
                                ->label('ยอดรวม (ไม่รวม VAT)')
                                ->numeric()
                                ->prefix('฿')
                                ->default(0.00)
                                ->readonly(),

                            Forms\Components\TextInput::make('tax_amount')
                                ->label('VAT 7%')
                                ->numeric()
                                ->prefix('฿')
                                ->default(0.00)
                                ->readonly(),

                            Forms\Components\TextInput::make('total_amount')
                                ->label('ยอดรวมทั้งสิ้น')
                                ->numeric()
                                ->prefix('฿')
                                ->default(0.00)
                                ->readonly(),
                        ]),
                    ]),

                Forms\Components\Section::make('Status Information')
                    ->description('Current status and workflow information')
                    ->schema([
                        Forms\Components\Grid::make(3)->schema([
                            Forms\Components\Select::make('status')
                                ->label('Status')
                                ->default('draft')
                                ->options([
                                    'draft' => 'Draft',
                                    'pending_approval' => 'Pending Approval',
                                    'approved' => 'Approved',
                                    'sent_to_supplier' => 'Sent to Supplier',
                                    'acknowledged' => 'Acknowledged',
                                    'partially_received' => 'Partially Received',
                                    'fully_received' => 'Fully Received',
                                    'closed' => 'Closed',
                                    'cancelled' => 'Cancelled',
                                    'rejected' => 'Rejected',
                                ])
                                ->disabled(fn ($record) => !$record || $record->status !== 'draft'),

                            Forms\Components\Toggle::make('is_confirmed')
                                ->label('Is Confirmed')
                                ->helperText('Vendor confirmation received'),

                            Forms\Components\TextInput::make('supplier_reference')
                                ->label('Supplier Reference')
                                ->maxLength(255)
                                ->placeholder('Supplier\'s reference number'),
                        ]),

                        Forms\Components\Textarea::make('rejection_reason')
                            ->label('Rejection Reason')
                            ->rows(3)
                            ->readonly()
                            ->visible(fn ($get) => in_array($get('status'), ['rejected']))
                            ->columnSpanFull(),

                        Forms\Components\Textarea::make('cancellation_reason')
                            ->label('Cancellation Reason')
                            ->rows(3)
                            ->readonly()
                            ->visible(fn ($get) => in_array($get('status'), ['cancelled']))
                            ->columnSpanFull(),

                        Forms\Components\Textarea::make('approval_history')
                            ->label('Approval History')
                            ->rows(3)
                            ->readonly()
                            ->visibleOn(['edit', 'view'])
                            ->columnSpanFull(),
                    ])
                    ->visibleOn(['edit', 'view']),
                
                Forms\Components\Section::make('File Attachments')
                    ->description('Upload supporting documents and files')
                    ->schema([
                        Forms\Components\Repeater::make('files')
                            ->relationship()
                            ->schema([
                                Forms\Components\Grid::make(3)->schema([
                                    Forms\Components\FileUpload::make('file_path')
                                        ->label('File')
                                        ->required()
                                        ->disk('public')
                                        ->directory('po-files')
                                        ->acceptedFileTypes(['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'])
                                        ->maxSize(10240) // 10MB
                                        ->live()
                                        ->afterStateUpdated(function ($state, $set) {
                                            if ($state) {
                                                // Auto-fill original name from uploaded file
                                                $fileName = pathinfo($state, PATHINFO_FILENAME);
                                                $extension = pathinfo($state, PATHINFO_EXTENSION);
                                                $set('original_name', $fileName . '.' . $extension);
                                                $set('file_name', $fileName);
                                            }
                                        })
                                        ->columnSpan(1),
                                        
                                    Forms\Components\TextInput::make('original_name')
                                        ->label('File Name')
                                        ->required()
                                        ->maxLength(255)
                                        ->columnSpan(1),
                                        
                                    Forms\Components\Select::make('file_category')
                                        ->label('Category')
                                        ->required()
                                        ->options([
                                            'po_document' => 'เอกสาร PO',
                                            'quotation' => 'ใบเสนอราคา',
                                            'specification' => 'รายละเอียดสินค้า',
                                            'attachment' => 'เอกสารแนบ',
                                            'delivery_note' => 'ใบส่งของ',
                                            'invoice' => 'ใบแจ้งหนี้',
                                            'other' => 'อื่นๆ',
                                        ])
                                        ->default('po_document')
                                        ->columnSpan(1),
                                ]),
                                
                                Forms\Components\Textarea::make('description')
                                    ->label('Description')
                                    ->rows(2)
                                    ->placeholder('Optional description of this file...')
                                    ->columnSpanFull(),
                            ])
                            ->columnSpanFull()
                            ->collapsible()
                            ->itemLabel(fn (array $state): ?string => $state['original_name'] ?? 'New File')
                            ->addActionLabel('Add File')
                            ->reorderableWithButtons()
                            ->cloneable()
                            ->minItems(0)
                            ->defaultItems(0),
                    ])
                    ->collapsible()
                    ->collapsed(),

                Forms\Components\Section::make('Purchase Order Items')
                    ->description('List of items to be ordered')
                    ->schema([
                        Forms\Components\Repeater::make('items')
                            ->relationship()
                            ->schema([
                        Forms\Components\Grid::make(6)
                            ->schema([
                                Forms\Components\TextInput::make('line_number')
                                    ->label('Line #')
                                    ->numeric()
                                    ->default(function ($get) {
                                        $items = $get('../../items') ?? [];
                                        return count($items) + 1;
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('item_code')
                                    ->label('Item Code')
                                    ->maxLength(100)
                                    ->columnSpan(1),
                                    
                                Forms\Components\Textarea::make('description')
                                    ->label('Description')
                                    ->required()
                                    ->rows(2)
                                    ->columnSpan(2),
                                    
                                Forms\Components\TextInput::make('quantity')
                                    ->label('Qty')
                                    ->numeric()
                                    ->required()
                                    ->minValue(0.01)
                                    ->step(0.01)
                                    ->live()
                                    ->afterStateUpdated(function ($state, Forms\Set $set, Forms\Get $get) {
                                        $unitPrice = $get('unit_price') ?? 0;
                                        $set('total_price', $state * $unitPrice);
                                        // Auto update PO totals
                                        static::updatePOTotals($get, $set);
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('unit_of_measure')
                                    ->label('Unit')
                                    ->required()
                                    ->maxLength(50)
                                    ->columnSpan(1),
                            ]),
                            
                        Forms\Components\Grid::make(6)
                            ->schema([
                                Forms\Components\TextInput::make('unit_price')
                                    ->label('Unit Price')
                                    ->numeric()
                                    ->prefix('₿')
                                    ->minValue(0)
                                    ->step(0.01)
                                    ->live()
                                    ->afterStateUpdated(function ($state, Forms\Set $set, Forms\Get $get) {
                                        $quantity = $get('quantity') ?? 0;
                                        $set('total_price', $quantity * $state);
                                        static::updatePOTotals($get, $set);
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('discount_rate')
                                    ->label('Discount %')
                                    ->numeric()
                                    ->suffix('%')
                                    ->minValue(0)
                                    ->maxValue(100)
                                    ->step(0.01)
                                    ->live()
                                    ->afterStateUpdated(function ($state, Forms\Set $set, Forms\Get $get) {
                                        $totalPrice = $get('total_price') ?? 0;
                                        $discountAmount = $totalPrice * ($state / 100);
                                        $set('discount_amount', $discountAmount);
                                        static::updatePOTotals($get, $set);
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('tax_rate')
                                    ->label('Tax %')
                                    ->numeric()
                                    ->suffix('%')
                                    ->minValue(0)
                                    ->maxValue(100)
                                    ->step(0.01)
                                    ->default(7.00) // Default VAT in Thailand
                                    ->live()
                                    ->afterStateUpdated(function ($state, Forms\Set $set, Forms\Get $get) {
                                        $totalPrice = $get('total_price') ?? 0;
                                        $discountAmount = $get('discount_amount') ?? 0;
                                        $taxableAmount = $totalPrice - $discountAmount;
                                        $set('tax_amount', $taxableAmount * ($state / 100));
                                        static::updatePOTotals($get, $set);
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('total_price')
                                    ->label('Subtotal')
                                    ->numeric()
                                    ->prefix('₿')
                                    ->disabled()
                                    ->dehydrated()
                                    ->columnSpan(1),
                                    
                                Forms\Components\DatePicker::make('delivery_date')
                                    ->label('Delivery Date')
                                    ->required()
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('account_code')
                                    ->label('Account Code')
                                    ->maxLength(50)
                                    ->columnSpan(1),
                            ]),
                            
                        Forms\Components\Grid::make(3)
                            ->schema([
                                Forms\Components\TextInput::make('discount_amount')
                                    ->label('Discount Amount')
                                    ->numeric()
                                    ->prefix('₿')
                                    ->disabled()
                                    ->dehydrated()
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('tax_amount')
                                    ->label('Tax Amount')
                                    ->numeric()
                                    ->prefix('₿')
                                    ->disabled()
                                    ->dehydrated()
                                    ->columnSpan(1),
                                    
                                Forms\Components\Select::make('status')
                                    ->label('Item Status')
                                    ->options([
                                        'pending' => 'Pending',
                                        'ordered' => 'Ordered',
                                        'delivered' => 'Delivered',
                                        'cancelled' => 'Cancelled',
                                    ])
                                    ->default('pending')
                                    ->columnSpan(1),
                            ]),
                            
                        Forms\Components\Textarea::make('specification')
                            ->label('Technical Specification')
                            ->rows(3)
                            ->columnSpanFull(),
                            
                        Forms\Components\Textarea::make('remarks')
                            ->label('Remarks')
                            ->rows(2)
                            ->columnSpanFull(),
                            ])
                            ->columnSpanFull()
                            ->collapsible()
                            ->itemLabel(fn (array $state): ?string => $state['description'] ?? 'New Item')
                            ->addActionLabel('Add Item')
                            ->reorderableWithButtons()
                            ->cloneable()
                            ->minItems(1)
                            ->live()
                            ->afterStateUpdated(function ($state, Forms\Set $set, Forms\Get $get) {
                                static::updatePOTotals($get, $set);
                            }),
                    ]),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('po_number')
                    ->label('PO Number')
                    ->searchable()
                    ->sortable(),

                Tables\Columns\TextColumn::make('po_title')
                    ->label('Title')
                    ->searchable()
                    ->limit(30)
                    ->tooltip(fn ($record) => $record->po_title),

                Tables\Columns\TextColumn::make('vendor.company_name')
                    ->label('Vendor')
                    ->sortable()
                    ->searchable(),

                Tables\Columns\TextColumn::make('department.name')
                    ->label('Department')
                    ->sortable(),

                Tables\Columns\BadgeColumn::make('status')
                    ->label('Status')
                    ->colors([
                        'secondary' => 'draft',
                        'info' => 'pending_approval',
                        'success' => 'approved',
                        'warning' => ['sent_to_supplier', 'sent_to_vendor'],
                        'primary' => 'acknowledged',
                        'success' => ['fully_received', 'received'],
                        'warning' => 'partially_received',
                        'gray' => 'closed',
                        'danger' => ['rejected', 'cancelled'],
                    ])
                    ->formatStateUsing(fn ($state) => match($state) {
                        'draft' => 'Draft',
                        'pending_approval' => 'Pending Approval', 
                        'approved' => 'Approved',
                        'sent_to_supplier' => 'Sent to Supplier',
                        'sent_to_vendor' => 'Sent to Vendor',
                        'acknowledged' => 'Acknowledged',
                        'fully_received' => 'Fully Received',
                        'partially_received' => 'Partially Received',
                        'received' => 'Received',
                        'closed' => 'Closed',
                        'cancelled' => 'Cancelled',
                        'rejected' => 'Rejected',
                        default => ucfirst(str_replace('_', ' ', $state)),
                    }),

                Tables\Columns\BadgeColumn::make('priority')
                    ->label('Priority')
                    ->colors([
                        'secondary' => 'low',
                        'primary' => 'medium',
                        'warning' => 'high',
                        'danger' => 'urgent',
                    ]),

                Tables\Columns\TextColumn::make('total_amount')
                    ->label('Total Amount')
                    ->money('THB')
                    ->sortable(),

                Tables\Columns\TextColumn::make('order_date')
                    ->label('Order Date')
                    ->date('d/m/Y')
                    ->sortable(),

                Tables\Columns\TextColumn::make('expected_delivery_date')
                    ->label('Expected Delivery')
                    ->date('d/m/Y')
                    ->sortable(),

                Tables\Columns\IconColumn::make('is_confirmed')
                    ->label('Confirmed')
                    ->boolean(),

                Tables\Columns\TextColumn::make('files_count')
                    ->label('Files')
                    ->counts('files')
                    ->badge()
                    ->color(fn ($state) => $state > 0 ? 'success' : 'gray')
                    ->tooltip('Number of attached files'),

                Tables\Columns\TextColumn::make('created_at')
                    ->label('Created')
                    ->dateTime('d/m/Y H:i')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->filters([
                Tables\Filters\SelectFilter::make('status')
                    ->options([
                        'draft' => 'Draft',
                        'pending_approval' => 'Pending Approval',
                        'approved' => 'Approved',
                        'rejected' => 'Rejected',
                        'delivered' => 'Delivered',
                        'completed' => 'Completed',
                        'cancelled' => 'Cancelled',
                    ])
                    ->default('pending_approval'),
                    
                Tables\Filters\SelectFilter::make('vendor_id')
                    ->relationship('vendor', 'company_name')
                    ->searchable()
                    ->preload(),
                    
                Tables\Filters\Filter::make('my_orders')
                    ->label('My Orders')
                    ->query(fn (Builder $query): Builder => $query->where('created_by', auth()->id())),
                    
                Tables\Filters\Filter::make('pending_my_approval')
                    ->label('Pending My Approval')
                    ->query(function (Builder $query): Builder {
                        $user = auth()->user();
                        return $query->where('status', 'pending_approval')
                            ->where(function ($query) use ($user) {
                                $query->where('po_approver_id', $user->id)
                                    ->orWhere(function ($query) use ($user) {
                                        if ($user->hasRole('admin') || $user->hasRole('procurement_manager')) {
                                            return $query;
                                        }
                                        if ($user->hasRole('department_head') && $user->department_id) {
                                            return $query->where('department_id', $user->department_id);
                                        }
                                        return $query->whereNull('id');
                                    });
                            });
                    })
                    ->visible(fn () => auth()->user()->hasAnyRole(['admin', 'procurement_manager', 'department_head'])),
                    
                Tables\Filters\Filter::make('requires_inspection')
                    ->label('Requires Inspection')
                    ->query(fn (Builder $query): Builder => $query->whereNotNull('inspection_committee_id')),
            ])
            ->actions([
                Tables\Actions\ViewAction::make(),
                Tables\Actions\EditAction::make(),

                // File Management Actions
                Tables\Actions\Action::make('viewFiles')
                    ->label('View Files')
                    ->icon('heroicon-o-document-text')
                    ->color('info')
                    ->visible(fn ($record) => $record->files->count() > 0)
                    ->modalHeading('Purchase Order Files')
                    ->modalContent(fn ($record) => view('filament.po-files-modal', ['files' => $record->files]))
                    ->modalWidth('6xl'),
                ApprovePurchaseOrderAction::make(),
                RejectPurchaseOrderAction::make(),

                // Enhanced PO Workflow Actions
                Tables\Actions\Action::make('submitForApproval')
                    ->label('Submit for Approval')
                    ->icon('heroicon-o-paper-airplane')
                    ->color('primary')
                    ->visible(fn ($record) => $record->status === 'draft' && $record->created_by === Auth::id())
                    ->requiresConfirmation()
                    ->modalHeading('Submit PO for Approval')
                    ->modalDescription('Are you sure you want to submit this Purchase Order for approval?')
                    ->action(function ($record) {
                        $record->update([
                            'status' => 'pending_approval',
                            'submitted_at' => now(),
                        ]);

                        Notification::make()
                            ->title('PO Submitted')
                            ->body('Purchase order has been submitted for approval')
                            ->success()
                            ->send();
                    }),

                Tables\Actions\Action::make('sendToVendor')
                    ->label('Send to Supplier')
                    ->icon('heroicon-o-share')
                    ->color('info')
                    ->visible(fn ($record) => $record->status === 'approved')
                    ->requiresConfirmation()
                    ->modalHeading('Send PO to Supplier')
                    ->modalDescription('Are you sure you want to send this Purchase Order to the supplier?')
                    ->action(function ($record) {
                        if (method_exists($record, 'sendToVendor') && $record->sendToVendor()) {
                            Notification::make()
                                ->title('PO Sent to Supplier')
                                ->body('Purchase order has been sent to supplier successfully')
                                ->success()
                                ->send();
                        } else {
                            $record->update([
                                'status' => 'sent_to_supplier',
                                'sent_at' => now(),
                            ]);
                            
                            Notification::make()
                                ->title('PO Sent to Supplier')
                                ->body('Purchase order has been sent to supplier successfully')
                                ->success()
                                ->send();
                        }
                    }),

                Tables\Actions\Action::make('markReceived')
                    ->label('Mark as Received')
                    ->icon('heroicon-o-check-badge')
                    ->color('success')
                    ->visible(fn ($record) => in_array($record->status, ['sent_to_supplier', 'acknowledged']))
                    ->form([
                        Forms\Components\Toggle::make('is_fully_received')
                            ->label('Fully Received')
                            ->helperText('Check if all items have been received completely')
                            ->default(true)
                            ->live(),
                            
                        Forms\Components\DatePicker::make('received_date')
                            ->label('Received Date')
                            ->default(now())
                            ->required(),
                            
                        Forms\Components\Textarea::make('receiving_notes')
                            ->label('Receiving Notes')
                            ->placeholder('Condition of goods, any issues, etc.')
                            ->rows(3),
                    ])
                    ->action(function ($record, array $data) {
                        if (method_exists($record, 'markReceived')) {
                            if ($record->markReceived($data['is_fully_received'] ?? true)) {
                                $message = ($data['is_fully_received'] ?? true) 
                                    ? 'Purchase order marked as fully received' 
                                    : 'Purchase order marked as partially received';
                                    
                                Notification::make()
                                    ->title('PO Received')
                                    ->body($message)
                                    ->success()
                                    ->send();
                            }
                        } else {
                            $status = ($data['is_fully_received'] ?? true) ? 'fully_received' : 'partially_received';
                            $record->update([
                                'status' => $status,
                                'received_date' => $data['received_date'],
                                'receiving_notes' => $data['receiving_notes'],
                            ]);
                            
                            Notification::make()
                                ->title('PO Received')
                                ->body('Purchase order has been marked as received')
                                ->success()
                                ->send();
                        }
                    }),

                Tables\Actions\Action::make('close')
                    ->label('Close PO')
                    ->icon('heroicon-o-lock-closed')
                    ->color('warning')
                    ->visible(fn ($record) => $record->status === 'fully_received')
                    ->requiresConfirmation()
                    ->modalHeading('Close Purchase Order')
                    ->modalDescription('Are you sure you want to close this Purchase Order? This action cannot be undone.')
                    ->action(function ($record) {
                        if (method_exists($record, 'close') && $record->close()) {
                            Notification::make()
                                ->title('PO Closed')
                                ->body('Purchase order has been closed successfully')
                                ->success()
                                ->send();
                        } else {
                            $record->update([
                                'status' => 'closed',
                                'closed_at' => now(),
                            ]);
                            
                            Notification::make()
                                ->title('PO Closed')
                                ->body('Purchase order has been closed successfully')
                                ->success()
                                ->send();
                        }
                    }),

                Tables\Actions\Action::make('cancel')
                    ->label('Cancel PO')
                    ->icon('heroicon-o-x-circle')
                    ->color('danger')
                    ->visible(fn ($record) => !in_array($record->status, ['closed', 'cancelled']))
                    ->form([
                        Forms\Components\Textarea::make('cancellation_reason')
                            ->label('Cancellation Reason')
                            ->required()
                            ->placeholder('Reason for cancelling this purchase order...')
                            ->rows(3),
                    ])
                    ->action(function ($record, array $data) {
                        if (method_exists($record, 'cancel')) {
                            if ($record->cancel($data['cancellation_reason'])) {
                                Notification::make()
                                    ->title('PO Cancelled')
                                    ->body('Purchase order has been cancelled successfully')
                                    ->warning()
                                    ->send();
                            }
                        } else {
                            $record->update([
                                'status' => 'cancelled',
                                'cancellation_reason' => $data['cancellation_reason'],
                            ]);
                            
                            Notification::make()
                                ->title('PO Cancelled')
                                ->body('Purchase order has been cancelled')
                                ->warning()
                                ->send();
                        }
                    }),
            ])
            ->bulkActions([
                Tables\Actions\BulkActionGroup::make([
                    Tables\Actions\DeleteBulkAction::make(),
                ]),
            ]);
    }

    public static function getRelations(): array
    {
        return [
            //
        ];
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListPurchaseOrders::route('/'),
            'create' => Pages\CreatePurchaseOrder::route('/create'),
            'edit' => Pages\EditPurchaseOrder::route('/{record}/edit'),
            'pending-approvals' => Pages\PendingPurchaseOrders::route('/pending-approvals'),
        ];
    }

    public static function getEloquentQuery(): Builder
    {
        return parent::getEloquentQuery()
            ->when(session('company_id'), function ($query) {
                return $query->where('company_id', session('company_id'));
            });
    }

    public static function updatePOTotals(Forms\Get $get, Forms\Set $set)
    {
        $items = $get('items') ?? [];
        
        $subtotal = 0;
        $totalTax = 0;
        $totalDiscount = 0;
        
        foreach ($items as $item) {
            $itemSubtotal = (float) ($item['total_price'] ?? 0);
            $itemDiscount = (float) ($item['discount_amount'] ?? 0);
            $itemTax = (float) ($item['tax_amount'] ?? 0);
            
            $subtotal += $itemSubtotal;
            $totalDiscount += $itemDiscount;
            $totalTax += $itemTax;
        }
        
        // Add shipping cost and other charges
        $shippingCost = (float) ($get('shipping_cost') ?? 0);
        $otherCharges = (float) ($get('other_charges') ?? 0);
        $stampDuty = (float) ($get('stamp_duty') ?? 0);
        
        // Calculate grand total
        $grandTotal = $subtotal - $totalDiscount + $totalTax + $shippingCost + $otherCharges + $stampDuty;
        
        // Update form fields with proper rounding
        $set('subtotal', round($subtotal, 2));
        $set('tax_amount', round($totalTax, 2));
        $set('total_amount', round($grandTotal, 2));
    }

    public static function mutateFormDataBeforeCreate(array $data): array
    {
        $data['company_id'] = session('company_id');
        $data['created_by'] = Auth::id();
        
        // Generate PO number if not provided
        if (empty($data['po_number'])) {
            $data['po_number'] = PurchaseOrder::generatePoNumber();
        }
        
        return $data;
    }

    // Note: This method is now handled in CreatePurchaseOrder and EditPurchaseOrder pages
    // to avoid conflicts and allow for more specific behavior per page
}
