<?php

namespace App\Filament\Resources;

use App\Filament\Resources\PurchaseRequisitionResource\Pages;
use App\Filament\Resources\PurchaseRequisitionResource\RelationManagers;
use App\Models\PurchaseRequisition;
use App\Filament\Actions\ApprovePurchaseRequisitionAction;
use App\Filament\Actions\RejectPurchaseRequisitionAction;
use Filament\Forms;
use Filament\Forms\Form;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\SoftDeletingScope;

class PurchaseRequisitionResource extends Resource
{
    protected static ?string $model = PurchaseRequisition::class;

    protected static ?string $navigationIcon = 'heroicon-o-document-text';
    protected static ?string $navigationLabel = 'Purchase Requisitions (ใบขอซื้อ)';
    protected static ?string $modelLabel = 'ใบขอซื้อ';
    protected static ?string $pluralModelLabel = 'ใบขอซื้อ';
    protected static ?string $navigationGroup = 'Procurement (จัดซื้อจัดจ้าง)';
    protected static ?int $navigationSort = 1;

    public static function form(Form $form): Form
    {
        return $form
            ->schema([
                Forms\Components\Select::make('company_id')
                    ->relationship('company', 'name')
                    ->required()
                    ->default(function () {
                        return session('company_id');
                    })
                    ->disabled(function () {
                        return session('company_id') !== null;
                    })
                    ->dehydrated(),
                Forms\Components\TextInput::make('pr_number')
                    ->required()
                    ->maxLength(255),
                Forms\Components\TextInput::make('title')
                    ->required()
                    ->maxLength(255),
                Forms\Components\TextInput::make('category')
                    ->required(),
                Forms\Components\TextInput::make('work_type')
                    ->required(),
                Forms\Components\TextInput::make('procurement_method'),
                Forms\Components\TextInput::make('procurement_budget')
                    ->numeric()
                    ->default(null),
                Forms\Components\Textarea::make('delivery_schedule')
                    ->columnSpanFull(),
                Forms\Components\Textarea::make('payment_schedule')
                    ->columnSpanFull(),
                Forms\Components\Select::make('procurement_committee_id')
                    ->relationship('procurementCommittee', 'name')
                    ->default(null),
                Forms\Components\Select::make('inspection_committee_id')
                    ->relationship('inspectionCommittee', 'name')
                    ->default(null),
                Forms\Components\Select::make('pr_approver_id')
                    ->relationship('prApprover', 'name')
                    ->default(null),
                Forms\Components\Select::make('other_stakeholder_id')
                    ->relationship('otherStakeholder', 'name')
                    ->default(null),
                Forms\Components\Select::make('department_id')
                    ->relationship('department', 'name')
                    ->required(),
                Forms\Components\Select::make('requester_id')
                    ->relationship('requester', 'name')
                    ->required(),
                Forms\Components\DatePicker::make('request_date')
                    ->required(),
                Forms\Components\DatePicker::make('required_date')
                    ->required(),
                Forms\Components\TextInput::make('purpose')
                    ->maxLength(255)
                    ->default(null),
                Forms\Components\Textarea::make('description')
                    ->columnSpanFull(),
                Forms\Components\TextInput::make('priority')
                    ->required(),
                Forms\Components\TextInput::make('status')
                    ->required(),
                Forms\Components\Textarea::make('rejection_reason')
                    ->columnSpanFull(),
                Forms\Components\TextInput::make('rejected_by')
                    ->numeric()
                    ->default(null),
                Forms\Components\Textarea::make('approval_comments')
                    ->columnSpanFull(),
                Forms\Components\TextInput::make('approved_by')
                    ->numeric()
                    ->default(null),
                Forms\Components\TextInput::make('current_approver_id')
                    ->numeric()
                    ->default(null),
                Forms\Components\TextInput::make('total_amount')
                    ->required()
                    ->numeric()
                    ->default(0.00),
                Forms\Components\TextInput::make('currency')
                    ->required()
                    ->maxLength(3)
                    ->default('THB'),
                Forms\Components\TextInput::make('budget_code')
                    ->maxLength(255)
                    ->default(null),
                Forms\Components\Textarea::make('notes')
                    ->columnSpanFull(),
                Forms\Components\TextInput::make('project_code')
                    ->maxLength(255)
                    ->default(null),
                Forms\Components\Toggle::make('is_budgeted')
                    ->required(),
                Forms\Components\Textarea::make('approval_history')
                    ->columnSpanFull(),
                Forms\Components\Textarea::make('rejection_reasons')
                    ->columnSpanFull(),
                Forms\Components\TextInput::make('created_by')
                    ->required()
                    ->numeric(),
                Forms\Components\TextInput::make('updated_by')
                    ->numeric()
                    ->default(null),
                Forms\Components\DateTimePicker::make('approved_at'),
                Forms\Components\DateTimePicker::make('rejected_at'),
                
                Forms\Components\Repeater::make('items')
                    ->relationship()
                    ->schema([
                        Forms\Components\Grid::make(6)
                            ->schema([
                                Forms\Components\TextInput::make('line_number')
                                    ->label('Line #')
                                    ->numeric()
                                    ->default(function ($get) {
                                        $items = $get('../../items') ?? [];
                                        return count($items) + 1;
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('item_code')
                                    ->label('Item Code')
                                    ->maxLength(100)
                                    ->columnSpan(1),
                                    
                                Forms\Components\Textarea::make('description')
                                    ->label('Description')
                                    ->required()
                                    ->rows(2)
                                    ->columnSpan(2),
                                    
                                Forms\Components\TextInput::make('quantity')
                                    ->label('Qty')
                                    ->numeric()
                                    ->required()
                                    ->minValue(0.01)
                                    ->step(0.01)
                                    ->reactive()
                                    ->afterStateUpdated(function ($state, callable $set, callable $get) {
                                        $unitPrice = $get('estimated_unit_price') ?? 0;
                                        $set('estimated_amount', $state * $unitPrice);
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('unit_of_measure')
                                    ->label('Unit')
                                    ->required()
                                    ->maxLength(50)
                                    ->columnSpan(1),
                            ]),
                            
                        Forms\Components\Grid::make(4)
                            ->schema([
                                Forms\Components\TextInput::make('estimated_unit_price')
                                    ->label('Unit Price')
                                    ->numeric()
                                    ->prefix('₿')
                                    ->minValue(0)
                                    ->step(0.01)
                                    ->reactive()
                                    ->afterStateUpdated(function ($state, callable $set, callable $get) {
                                        $quantity = $get('quantity') ?? 0;
                                        $set('estimated_amount', $quantity * $state);
                                    })
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('estimated_amount')
                                    ->label('Total Amount')
                                    ->numeric()
                                    ->prefix('₿')
                                    ->disabled()
                                    ->dehydrated()
                                    ->columnSpan(1),
                                    
                                Forms\Components\DatePicker::make('required_date')
                                    ->label('Required Date')
                                    ->required()
                                    ->columnSpan(1),
                                    
                                Forms\Components\TextInput::make('account_code')
                                    ->label('Account Code')
                                    ->maxLength(50)
                                    ->columnSpan(1),
                            ]),
                            
                        Forms\Components\Textarea::make('specification')
                            ->label('Technical Specification')
                            ->rows(3)
                            ->columnSpanFull(),
                            
                        Forms\Components\Textarea::make('remarks')
                            ->label('Remarks')
                            ->rows(2)
                            ->columnSpanFull(),
                    ])
                    ->columnSpanFull()
                    ->collapsible()
                    ->itemLabel(fn (array $state): ?string => $state['description'] ?? 'Item')
                    ->addActionLabel('Add Item')
                    ->reorderableWithButtons()
                    ->cloneable(),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('company.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('pr_number')
                    ->searchable(),
                Tables\Columns\TextColumn::make('title')
                    ->searchable(),
                Tables\Columns\TextColumn::make('category'),
                Tables\Columns\TextColumn::make('work_type'),
                Tables\Columns\TextColumn::make('procurement_method'),
                Tables\Columns\TextColumn::make('procurement_budget')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('procurementCommittee.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('inspectionCommittee.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('prApprover.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('otherStakeholder.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('department.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('requester.name')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('request_date')
                    ->date()
                    ->sortable(),
                Tables\Columns\TextColumn::make('required_date')
                    ->date()
                    ->sortable(),
                Tables\Columns\TextColumn::make('purpose')
                    ->searchable(),
                Tables\Columns\BadgeColumn::make('priority')
                    ->colors([
                        'gray' => 'low',
                        'primary' => 'normal',
                        'warning' => 'high',
                        'danger' => 'urgent',
                    ])
                    ->formatStateUsing(fn (string $state): string => ucfirst($state)),
                Tables\Columns\BadgeColumn::make('status')
                    ->colors([
                        'secondary' => 'draft',
                        'warning' => 'pending_approval',
                        'success' => 'approved',
                        'danger' => 'rejected',
                        'gray' => 'cancelled',
                    ])
                    ->formatStateUsing(fn (string $state): string => ucfirst(str_replace('_', ' ', $state))),
                Tables\Columns\TextColumn::make('rejected_by')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('approved_by')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('current_approver_id')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('total_amount')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('currency')
                    ->searchable(),
                Tables\Columns\TextColumn::make('budget_code')
                    ->searchable(),
                Tables\Columns\TextColumn::make('project_code')
                    ->searchable(),
                Tables\Columns\IconColumn::make('is_budgeted')
                    ->boolean(),
                Tables\Columns\TextColumn::make('created_by')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('updated_by')
                    ->numeric()
                    ->sortable(),
                Tables\Columns\TextColumn::make('approved_at')
                    ->dateTime()
                    ->sortable(),
                Tables\Columns\TextColumn::make('rejected_at')
                    ->dateTime()
                    ->sortable(),
                Tables\Columns\TextColumn::make('created_at')
                    ->dateTime()
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
                Tables\Columns\TextColumn::make('updated_at')
                    ->dateTime()
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
                Tables\Columns\TextColumn::make('deleted_at')
                    ->dateTime()
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->filters([
                Tables\Filters\SelectFilter::make('status')
                    ->options([
                        'draft' => 'Draft',
                        'pending_approval' => 'Pending Approval',
                        'approved' => 'Approved',
                        'rejected' => 'Rejected',
                        'cancelled' => 'Cancelled',
                    ])
                    ->default('pending_approval'),
                    
                Tables\Filters\SelectFilter::make('priority')
                    ->options([
                        'low' => 'Low',
                        'normal' => 'Normal',
                        'high' => 'High',
                        'urgent' => 'Urgent',
                    ]),
                    
                Tables\Filters\SelectFilter::make('department_id')
                    ->relationship('department', 'name')
                    ->searchable()
                    ->preload(),
                    
                Tables\Filters\Filter::make('my_requests')
                    ->label('My Requests')
                    ->query(fn (Builder $query): Builder => $query->where('requester_id', auth()->id())),
                    
                Tables\Filters\Filter::make('pending_my_approval')
                    ->label('Pending My Approval')
                    ->query(function (Builder $query): Builder {
                        $user = auth()->user();
                        return $query->where('status', 'pending_approval')
                            ->where(function ($query) use ($user) {
                                $query->where('pr_approver_id', $user->id)
                                    ->orWhere(function ($query) use ($user) {
                                        if ($user->hasRole('admin') || $user->hasRole('procurement_manager')) {
                                            return $query;
                                        }
                                        if ($user->hasRole('department_head') && $user->department_id) {
                                            return $query->where('department_id', $user->department_id);
                                        }
                                        return $query->whereNull('id');
                                    });
                            });
                    })
                    ->visible(fn () => auth()->user()->hasAnyRole(['admin', 'procurement_manager', 'department_head'])),
            ])
            ->actions([
                Tables\Actions\ViewAction::make(),
                Tables\Actions\EditAction::make(),
                ApprovePurchaseRequisitionAction::make(),
                RejectPurchaseRequisitionAction::make(),
            ])
            ->bulkActions([
                Tables\Actions\BulkActionGroup::make([
                    Tables\Actions\DeleteBulkAction::make(),
                    
                    Tables\Actions\BulkAction::make('bulk_approve')
                        ->label('Bulk Approve')
                        ->icon('heroicon-o-check-circle')
                        ->color('success')
                        ->requiresConfirmation()
                        ->modalHeading('Bulk Approve Purchase Requisitions')
                        ->modalDescription('Are you sure you want to approve all selected purchase requisitions?')
                        ->action(function ($records) {
                            $user = auth()->user();
                            
                            foreach ($records as $record) {
                                if ($record->status === 'pending_approval') {
                                    $record->update([
                                        'status' => 'approved',
                                        'approved_by' => $user->id,
                                        'approved_at' => now(),
                                    ]);
                                    
                                    event(new \App\Events\PurchaseRequisitionApproved($record, $user));
                                }
                            }
                        })
                        ->visible(fn () => auth()->user()->hasAnyRole(['admin', 'procurement_manager', 'department_head'])),
                        
                    Tables\Actions\BulkAction::make('export_to_excel')
                        ->label('Export to Excel')
                        ->icon('heroicon-o-document-arrow-down')
                        ->color('info')
                        ->action(function ($records) {
                            // This would integrate with Excel export functionality
                            return response()->streamDownload(function () use ($records) {
                                $csv = "PR Number,Title,Status,Requester,Total Amount,Created Date\n";
                                foreach ($records as $record) {
                                    $csv .= implode(',', [
                                        $record->pr_number,
                                        '"' . $record->title . '"',
                                        $record->status,
                                        $record->requester?->name ?? 'N/A',
                                        $record->total_amount,
                                        $record->created_at->format('Y-m-d'),
                                    ]) . "\n";
                                }
                                echo $csv;
                            }, 'purchase_requisitions_' . now()->format('Y-m-d_H-i-s') . '.csv');
                        }),
                        
                    Tables\Actions\BulkAction::make('change_status')
                        ->label('Change Status')
                        ->icon('heroicon-o-arrow-path')
                        ->color('warning')
                        ->form([
                            Forms\Components\Select::make('status')
                                ->label('New Status')
                                ->options([
                                    'draft' => 'Draft',
                                    'pending_approval' => 'Pending Approval',
                                    'approved' => 'Approved',
                                    'rejected' => 'Rejected',
                                    'cancelled' => 'Cancelled',
                                ])
                                ->required(),
                        ])
                        ->action(function ($records, $data) {
                            foreach ($records as $record) {
                                $record->update(['status' => $data['status']]);
                            }
                        })
                        ->visible(fn () => auth()->user()->hasRole('admin')),
                ]),
            ]);
    }

    public static function getRelations(): array
    {
        return [
            //
        ];
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListPurchaseRequisitions::route('/'),
            'create' => Pages\CreatePurchaseRequisition::route('/create'),
            'edit' => Pages\EditPurchaseRequisition::route('/{record}/edit'),
        ];
    }

    public static function getEloquentQuery(): Builder
    {
        return parent::getEloquentQuery()
            ->when(session('company_id'), function ($query) {
                return $query->where('company_id', session('company_id'));
            });
    }
}
